<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Partidos - Voto Informado CR</title>
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body style="background:#0d111c;color:white;font-family:system-ui,sans-serif;margin:0;padding:0;">
  <main style="max-width:800px;margin:auto;padding:20px;">
    <h1 style="text-align:center;margin-bottom:20px;">Consulta sobre Partidos</h1>
    <section id="search-section" class="page">
      <form id="qa-form" style="display:flex;gap:8px;">
        <input id="qa-input" name="q" type="text" placeholder="Preguntá algo sobre los partidos…" value="{{ q }}" style="flex:1;background:#1a1e33;color:white;border:none;border-radius:8px;padding:10px;" />
        <button id="qa-send" type="submit" style="background:#5b6df0;color:white;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;">Preguntar</button>
      </form>
    </section>
    <section id="qa-section" class="page" style="display:none; margin-top: 16px;">
      <h2 style="margin:0 0 8px;">Resultados para: <em id="qa-query"></em></h2>
      <div id="qa-answer" class="msg msg--bot" style="background:#1a1e33;padding:12px;border-radius:12px;"></div>
      <div id="qa-citations" class="citations" style="font-size:.9rem;color:#a9b0be;margin-top:8px;"></div>
    </section>
    <!-- Follow-up / mini-chat -->
    <section id="followup-section" class="page" style="margin-top: 24px; display:none;">
      <h3 style="margin-bottom:8px;">¿Querés preguntar algo más?</h3>
      <div style="display:flex;gap:8px;">
        <input id="followup-input" type="text" placeholder="Escribí tu siguiente pregunta y presioná Enter…" style="flex:1;background:#1a1e33;color:white;border:none;border-radius:8px;padding:10px;">
        <button id="followup-send" style="background:#5b6df0;color:white;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;">Preguntar</button>
      </div>
      <div id="chat-thread" style="margin-top:12px;display:flex;flex-direction:column;gap:12px;"></div>
    </section>
    <div class="ad-slot" style="margin-top:32px;text-align:center;">
      <p style="opacity:.6;">[Espacio publicitario]</p>
    </div>
  </main>
  <script>
    const form = document.getElementById('qa-form');
    const input = document.getElementById('qa-input');
    const qaSection = document.getElementById('qa-section');
    const qaAnswer = document.getElementById('qa-answer');
    const qaCitations = document.getElementById('qa-citations');
    const qaQuery = document.getElementById('qa-query');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = (input.value || '').trim();
      if (!q) return;
      qaSection.style.display = 'block';
      qaQuery.textContent = q;
      qaAnswer.textContent = 'Pensando…';
      qaCitations.textContent = '';
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q }),
        });
        const data = await res.json();
        qaAnswer.textContent = data.answer || 'Sin respuesta';
        if (data.citations && data.citations.length) {
          const list = data.citations.map(c => `<li>${c.party} — ${c.title} (p. ${c.page})</li>`).join('');
          qaCitations.innerHTML = `<strong>Fuentes:</strong><ul>${list}</ul>`;
        }
      } catch (err) {
        qaAnswer.textContent = 'Error al contactar el servidor.';
      }
    });
    // Agregar mini-chat para follow-ups
    const followupSection = document.getElementById('followup-section');
    const fInput = document.getElementById('followup-input');
    const fSend = document.getElementById('followup-send');
    const thread = document.getElementById('chat-thread');
    function addMessage(role, text) {
      const div = document.createElement('div');
      div.style.background = role === 'user' ? '#242b4a' : '#1a1e33';
      div.style.color = 'white';
      div.style.padding = '10px';
      div.style.borderRadius = '8px';
      div.textContent = text;
      thread.appendChild(div);
    }
    function sendFollowup() {
      const q = (fInput.value || '').trim();
      if (!q) return;
      addMessage('user', q);
      fInput.value = '';
      addMessage('bot', 'Pensando...');
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: q }),
      })
      .then(r => r.json())
      .then(data => {
        thread.lastChild.textContent = data.answer || 'Sin respuesta';
        followupSection.scrollIntoView({ behavior: 'smooth', block: 'end' });
      })
      .catch(() => { thread.lastChild.textContent = 'Error contactando la API'; });
    }
    fSend.onclick = sendFollowup;
    fInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendFollowup(); });
    document.getElementById('qa-section').addEventListener('DOMSubtreeModified', () => {
      if (qaAnswer.textContent.trim() !== '') followupSection.style.display = '';
    });
  </script>
</body>
</html>
